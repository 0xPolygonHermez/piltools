<html>
<title>PILviewer</title>
<!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
<!-- JavaScript Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>

<script>
let base = 17;

function changeBase () {
    base = event.target.value;
    refreshTable();
}
let polJson;

const loadData = async () => {
    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);

    base = document.querySelector(".pil-query-params select[name='base']").value;

    const polsResp = await fetch('http://localhost:8080/pols');
    const polsJson = await polsResp.json(); //extract JSON from the http response

    let content;
    for (const polname of polsJson.pols) {
        content += `<option value="${polname}">${polname}</option>`;
    }
    document.getElementById("pols-select-items").innerHTML = content;

    let url = 'http://localhost:8080/query?compact';
    for (const param of ['from', 'count','name','filter', 'trigger']) {
        if (urlParams.has(param)) {
            url += '&'+param+'='+urlParams.get(param);
            document.querySelector(".pil-query-params input[name='"+param+"']").value = urlParams.get(param);
        }
    }
    console.log(url);
    const polResp = await fetch(url);
    polJson = await polResp.json(); //extract JSON from the http response
    refreshTable();
}
function refreshTable()
{
    let content = "<tr>";
    for (title of polJson.titles) {
        title = title.split('.').join('</br>');
        content += '<th scope="col">' + title + '</th>';
    }
    content += "</tr>";
    document.getElementById("pols-titles").innerHTML = content;

    content = "";
    for (let ivalues = 0; ivalues < polJson.values.length; ++ivalues) {
        const values = polJson.values[ivalues];
        content += '<tr><th align="right" scope="row">' + values[0] + '</th>';
        for (let index = 1; index < values.length; ++index) {
            let value = values[index];
            extra = ((ivalues > 0) && (polJson.values[ivalues-1][index] != value)) ? ' style="background-color:#ffe391"':'';
            if (base == 16) {
                value = '0x'+value.toString(16).toUpperCase();
            } else if (base == 17) {
                value = (BigInt(value) > 9223372034707292160n) ? -(0xFFFFFFFF00000001n - BigInt(value)) : value;
            } else {
                value = value.toString(base);
            }

            content += '<td' + extra + ' align="right">' + value +'</td>';
        }
        content += '</tr>'
    }
    document.getElementById("pols-values").innerHTML = content;
  // do something with myJson
}
</script>
<body onload="loadData()">
<H1>PIL viewer</H1>
<div>
    <div class="collapse" id="collapseExample">
        <div class="card card-body">
          Some placeholder content for the collapse component. This panel is hidden by default but revealed when the user activates the relevant trigger.
          <select class="select" multiple id="pols-select-items">
            <option value="1">One</option>
        </select>
            </div>
      </div>
    <form method="GET">
        <div class="row pil-query-params">
            <div class="col-1">
              <label for="inputEmail4" class="form-label">from (omega)</label>
              <input type="text" class="form-control" placeholder="from" aria-label="from" name="from" value="0">
            </div>
            <div class="col-1">
                <label for="inputEmail4" class="form-label">count</label>
                <input type="text" class="form-control" placeholder="count" aria-label="count" name="count" value="10">
            </div>
            <div class="col-3 input-group mb-3">
                <input type="text" class="form-control" placeholder="names" aria-label="names" name="name">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">select</button>
                </div>
            </div>
            <div class="col-2">
                <label for="inputEmail4" class="form-label">filter</label>
                <input type="text" class="form-control" placeholder="filter" aria-label="filter" name="filter">
            </div>
            <div class="col-2">
                <label for="inputEmail4" class="form-label">trigger</label>
                <input type="text" class="form-control" placeholder="trigger" aria-label="trigger" name="trigger">
            </div>
            <div class="col-1">
                <button type="submit" class="btn btn-primary">refresh</button>
            </div>
            <div class="col-1" onchange="changeBase(event)" >
                <select class="form-select" aria-label="base" name="base">
                    <option value="2">Binary</option>
                    <option value="8">Octal</option>
                    <option value="10" selected>Decimal</option>
                    <option value="16">Hexa</option>
                    <option value="17">FF-Int</option>
                </select>
            </div>
        </div>

    </form>

    <div class="table-responsive">
        <table class="table">
            <thead id="pols-titles">
                <tr>
                  <th scope="col">w</th>
                </tr>
            </thead>
            <tbody id="pols-values">
            </tbody>
        </table>


    </div>
</div>
</body>
</html>